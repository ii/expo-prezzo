<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Hello!</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <script src="/app.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/qrcode.min.js"></script>
  <body>
    <h1>Hello!</h1>
    <canvas></canvas>
  </body>
  <script>
   const URL = window.location.origin
   const socket = io(URL, {autoConnect: false});

   const title = document.querySelector("h1");
   const canvas = document.querySelector("canvas");

   // Places QR code in canvas element with val as its value
   function renderQRCode (val) {
     QRCode.toCanvas(canvas, val, (error) => {
       if (error) {
         console.log('error rendering qr code', {error, value: val});
       } else {
         console.log('qr code success!', {value: val});
       }
     });
   };

   socket.on("connection initialized", (monitor) => {
     if (monitor) {
       title.textContent = `Monitor, code name ${monitor.monitorName}`;
       renderQRCode(`${window.location.origin}/presentations.html?m=${monitor.monitorName}`);
     } else {
       title.textContent = 'nope';
     }
   });

   socket.on("monitor added", (monitor) => {
     sessionStorage.setItem("monitor", JSON.stringify(monitor));
     title.textContent = `Monitor, code name ${monitor.monitorName}`;
     socket.emit("thank you")
   })

   document.addEventListener("DOMContentLoaded", () => {
     let monitor = JSON.parse(sessionStorage.getItem("monitor"));
     if (monitor ) {
       socket.auth = { monitor };
       socket.connect();
     } else {
       document.querySelector("h1").textContent = "hi, stranger";
       socket.connect();
       socket.emit("new monitor")
     }
   })
  </script>
</html>

<!-- socket.on('hello', data => {
     let { name, adjective } = data;
     console.log({data});
     });

     socket.on("new token", ({ sessionID, socketID, secret }) => {
     const monitor = socket.auth.sessionID
     if (sessionID !== monitor) {
     console.log("no match", {monitor, sessionID})
     return
     } else {
     console.log("match!", {monitor, sessionID})
     const monitorName = sessionStorage.getItem("monitorName")
     title.textContent = `Monitor: ${monitorName} has synced up to ${socketID}`
     sessionStorage.setItem("token", JSON.stringify({ socketID }))
     }

     console.log("what happening", socket.auth)
     })

     socket.on("session", ({ sessionID, monitorName, isMonitor }) => {
     // attach the session ID to the next reconnection attempts
     socket.auth = { sessionID };
     // store it in the sessionStorage
     sessionStorage.setItem("sessionID", sessionID);
     // save the ID of the user
     socket.monitorName = monitorName;
     socket.isMonitor = socket.isMonitor;
     if (isMonitor) {
     title.textContent = `Monitor: ${monitorName}`;
     renderQRCode(`${window.location.origin}/presentations.html?m=${sessionID}`);
     } else {
     title.textContent = `session ${sessionID}`;
     }
     });

     socket.on("monitor go!", ({ monitorName, sessionID }) => {
     if (sessionStorage.getItem("sessionID") !== null
     && sessionStorage.getItem("monitorName") !== null) {
     console.log("This monitor is initialised")
     return
     }
     console.log("moniktor go", {sessionID})
     sessionStorage.setItem("monitorName", monitorName)
     title.textContent = `Monitor: ${monitorName}`;
     renderQRCode(`${window.location.origin}/presentations.html?m=${sessionID}`);
     });

     socket.on("set presentation", ({ presentation, sessionID }) => {
     const monitor = socket.auth.sessionID
     if (sessionID !== monitor) {
     return
     } else {
     prezzyLink = `${window.location.origin}/presentations/${presentation}/presentation_client.html`
     window.location.href = prezzyLink;
     }
     }); -->
