<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Hello!</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <script src="/app.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/qrcode.min.js"></script>
  <body>
    <h1>Hello!</h1>
    <canvas></canvas>
  </body>
  <script>
   const URL = window.location.origin
   const socket = io(URL, {autoConnect: false});

   const title = document.querySelector("h1");
   const canvas = document.querySelector("canvas");

   const localMonitor = () =>
     JSON.parse(sessionStorage.getItem('monitor'));

   // Places QR code in canvas element with val as its value
   function renderQRCode (val) {
     QRCode.toCanvas(canvas, val, (error) => {
       if (error) {
         console.log('error rendering qr code', {error, value: val});
       } else {
         console.log('qr code success!', {value: val});
       }
     });
   };

   socket.on("connection initialized", (monitor) => {
     if (monitor) {
       title.textContent = `Monitor, code name ${monitor.monitorName}`;
       renderQRCode(`${window.location.origin}/presentations.html?m=${monitor.monitorName}`);
     } else {
       return
     }
   });

   socket.on("monitor added", (monitor) => {
     sessionStorage.setItem("monitor", JSON.stringify(monitor));
     title.textContent = `Monitor, code name ${monitor.monitorName}`;
   })

   socket.on("new token supplied", (sotw) => {
     thisMonitor = localMonitor();
     monitorState = sotw.find(m=>m.monitorID === thisMonitor.monitorID);
     if (monitorState) {
       sessionStorage.setItem('monitor', JSON.stringify(monitorState))
     } else {
       console.error("local monitor doesn't exist in sotw.", {thisMonitor, sotw});
     }
   });

   socket.on("monitor presentation updated", (sotw) => {
     const thisMonitor = localMonitor();
     const monitor = sotw.find(m => m.monitorID === thisMonitor.monitorID);
     if (monitor && monitor.presentation !== '') {
       window.location.href = `${window.location.origin}/presentations/${monitor.presentation}/presentation_client.html`;
     } else {
       console.error("monitor updated to an empty presentation.");
     }
   });

   document.addEventListener("DOMContentLoaded", () => {
     let monitor = JSON.parse(sessionStorage.getItem("monitor"));
     if (monitor) {
       socket.auth = { monitor };
       socket.connect();
     } else {
       document.querySelector("h1").textContent = "Initializing Monitor...";
       socket.connect();
       socket.emit("new monitor");
     }
   })
  </script>
</html>
